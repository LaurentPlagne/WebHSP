<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <title>Data Plotter</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <header class="container">
        <hgroup>
            <h1>Data Plotter</h1>
            <h2>Process and visualize data collections</h2>
        </hgroup>
        <nav>
            <ul>
                <li><button class="secondary" id="theme-switcher">Toggle Theme</button></li>
            </ul>
        </nav>
    </header>
    <main class="container">
        <div class="grid">
            <!-- Left Column: Inputs -->
            <div>
                <article id="input-article">
                    <hgroup>
                        <h2>1. Select an Existing Dataset</h2>
                    </hgroup>
                    <select id="dataset-select"></select>

                    <hgroup>
                        <h2>2. Upload a New Dataset</h2>
                    </hgroup>
                    <form id="upload-form">
                        <input type="file" id="file-input" name="file" accept=".json,.csv">
                        <button type="submit">Upload</button>
                    </form>

                    <hgroup>
                        <h2>3. Use Direct Input</h2>
                        <p>Enter data as a JSON array, e.g., <code>[1.1, 2.2, 3.3]</code></p>
                    </hgroup>
                    <textarea id="direct-input" rows="5" placeholder="[1.1, 2.2, 3.3]"></textarea>

                    <footer>
                        <button id="process-btn">Process Current Input</button>
                    </footer>
                </article>
            </div>
            <!-- Right Column: Plots -->
            <div>
                <article>
                    <hgroup>
                        <h2>Original Data</h2>
                    </hgroup>
                    <div id="plot-original" style="min-height: 370px;"></div>
                </article>
                <article>
                    <hgroup>
                        <h2>Processed Data</h2>
                        <button id="download-btn" class="outline" disabled>Download Result (CSV)</button>
                    </hgroup>
                    <div id="plot-processed" style="min-height: 370px;"></div>
                </article>
            </div>
        </div>
    </main>
    <script>
        const datasetSelect = document.getElementById('dataset-select');
        const processBtn = document.getElementById('process-btn');
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const plotOriginalDiv = document.getElementById('plot-original');
        const plotProcessedDiv = document.getElementById('plot-processed');
        const directInput = document.getElementById('direct-input');
        const downloadBtn = document.getElementById('download-btn');

        // Fetch datasets and populate the dropdown
        async function fetchDatasets() {
            try {
                const response = await fetch('/api/datasets');
                const datasets = await response.json();
                datasetSelect.innerHTML = '';
                datasets.forEach(dataset => {
                    const option = document.createElement('option');
                    option.value = dataset;
                    option.textContent = dataset;
                    datasetSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching datasets:', error);
            }
        }

        let currentOriginalData = [];
        let processedData = []; // To store the result for download
        const plotLayout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: 'var(--pico-contrast)' }
        };

        async function plotOriginalData(sourceType, sourceValue) {
            let data;
            try {
                if (sourceType === 'dataset') {
                    const response = await fetch(`/datasets/${sourceValue}`);
                    if (sourceValue.endsWith('.csv')) {
                        const csvText = await response.text();
                        data = csvText.split(/\r?\n/).filter(line => line.trim() !== '').map(Number);
                    } else {
                        data = await response.json();
                    }
                } else if (sourceType === 'direct') {
                    data = JSON.parse(sourceValue);
                    if (!Array.isArray(data)) throw new Error("Input is not a JSON array.");
                }
                currentOriginalData = data; // Store for processing
                Plotly.newPlot(plotOriginalDiv, [{ y: data, mode: 'lines+markers', name: 'Original' }], { ...plotLayout, title: 'Original Data' });
            } catch (error) {
                console.error("Error plotting original data:", error);
                Plotly.purge(plotOriginalDiv); // Clear plot on error
                currentOriginalData = [];
            }
        }

        // Process the current data
        processBtn.addEventListener('click', async () => {
            if (currentOriginalData.length === 0) {
                alert('No valid data to process.');
                return;
            }

            try {
                // The new endpoint can handle the data directly
                const response = await fetch('/api/process_direct', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: currentOriginalData })
                });
                processedData = await response.json(); // Store the data
                Plotly.newPlot(plotProcessedDiv, [{ y: processedData, mode: 'lines+markers', name: 'Processed' }], { ...plotLayout, title: 'Processed Data' });
                downloadBtn.disabled = false; // Enable the download button
            } catch (error) {
                console.error('Error processing data:', error);
                processedData = [];
                downloadBtn.disabled = true;
            }
        });

        // Handle download button click
        downloadBtn.addEventListener('click', () => {
            if (processedData.length === 0) {
                alert('No data to download.');
                return;
            }

            // Convert array to CSV string
            const csvContent = "data:text/csv;charset=utf-8,"
                + "processed_value\n" // Header
                + processedData.join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "processed_data.csv");
            document.body.appendChild(link); // Required for FF

            link.click(); // This will download the data file
            document.body.removeChild(link);
        });

        // Handle file upload
        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file to upload.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                if (response.ok) {
                    alert('File uploaded successfully!');
                    fetchDatasets(); // Refresh the dataset list
                } else {
                    alert('Error uploading file.');
                }
            } catch (error) {
                console.error('Error uploading file:', error);
            }
        });

        // Add event listeners for real-time plotting
        datasetSelect.addEventListener('change', () => {
            plotOriginalData('dataset', datasetSelect.value);
            directInput.value = ''; // Clear other input
        });

        directInput.addEventListener('input', () => {
            plotOriginalData('direct', directInput.value);
            datasetSelect.value = ''; // Clear other input
        });

        // Override the fetchDatasets to plot on load
        const originalFetchDatasets = fetchDatasets;
        fetchDatasets = async () => {
            await originalFetchDatasets();
            if (datasetSelect.options.length > 0) {
                datasetSelect.value = datasetSelect.options[0].value;
                plotOriginalData('dataset', datasetSelect.value);
            }
        };

        // --- Theme Switcher Logic ---
        const themeSwitcher = document.getElementById('theme-switcher');
        const htmlElement = document.documentElement;

        function setTheme(theme) {
            htmlElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }

        themeSwitcher.addEventListener('click', () => {
            const currentTheme = htmlElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        });

        // Apply saved theme on load
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        });

        // Initial fetch of datasets
        fetchDatasets();
    </script>
</body>
</html>
