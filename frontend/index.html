<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <title>Data Plotter</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <main class="container">
        <h1>Data Plotter</h1>

        <article>
            <hgroup>
                <h2>1. Select an Existing Dataset</h2>
            </hgroup>
            <select id="dataset-select"></select>
            <button id="process-btn">Process Selected Dataset</button>
        </article>

        <article>
            <hgroup>
                <h2>2. Upload a New Dataset</h2>
            </hgroup>
            <form id="upload-form">
                <input type="file" id="file-input" name="file" accept=".json,.csv">
                <button type="submit">Upload</button>
            </form>
        </article>

        <article>
            <hgroup>
                <h2>3. Use Direct Input</h2>
                <p>Enter data as a JSON array, e.g., <code>[1.1, 2.2, 3.3]</code></p>
            </hgroup>
            <textarea id="direct-input" rows="5" placeholder="[1.1, 2.2, 3.3]"></textarea>
            <button id="process-direct-btn">Process Direct Input</button>
        </article>

        <div class="grid">
            <div id="plot-original"></div>
            <div id="plot-processed"></div>
        </div>
    </main>
    <script>
        const datasetSelect = document.getElementById('dataset-select');
        const processBtn = document.getElementById('process-btn');
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const plotOriginalDiv = document.getElementById('plot-original');
        const plotProcessedDiv = document.getElementById('plot-processed');
        const directInput = document.getElementById('direct-input');
        const processDirectBtn = document.getElementById('process-direct-btn');

        // Fetch datasets and populate the dropdown
        async function fetchDatasets() {
            try {
                const response = await fetch('/api/datasets');
                const datasets = await response.json();
                datasetSelect.innerHTML = '';
                datasets.forEach(dataset => {
                    const option = document.createElement('option');
                    option.value = dataset;
                    option.textContent = dataset;
                    datasetSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching datasets:', error);
            }
        }

        // Process the selected dataset
        processBtn.addEventListener('click', async () => {
            const selectedDataset = datasetSelect.value;
            if (!selectedDataset) {
                alert('Please select a dataset.');
                return;
            }

            try {
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dataset: selectedDataset })
                });
                const processedData = await response.json();

                // Fetch original data to plot alongside processed data
                const originalResponse = await fetch(`/datasets/${selectedDataset}`);
                let originalData;
                if (selectedDataset.endsWith('.csv')) {
                    const csvText = await originalResponse.text();
                    originalData = csvText.split(/\r?\n/).filter(line => line.trim() !== '').map(Number);
                } else {
                    originalData = await originalResponse.json();
                }

                // Plot the data
                const layout = {
                    title: 'Original Data',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: 'var(--pico-contrast)' }
                };
                Plotly.newPlot(plotOriginalDiv, [{ y: originalData, mode: 'lines+markers', name: 'Original' }], layout);
                Plotly.newPlot(plotProcessedDiv, [{ y: processedData, mode: 'lines+markers', name: 'Processed' }], { ...layout, title: 'Processed Data' });
            } catch (error) {
                console.error('Error processing dataset:', error);
            }
        });

        // Handle file upload
        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file to upload.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                if (response.ok) {
                    alert('File uploaded successfully!');
                    fetchDatasets(); // Refresh the dataset list
                } else {
                    alert('Error uploading file.');
                }
            } catch (error) {
                console.error('Error uploading file:', error);
            }
        });

        // Initial fetch of datasets
        fetchDatasets();

        // Handle direct input processing
        processDirectBtn.addEventListener('click', async () => {
            const inputText = directInput.value.trim();
            if (!inputText) {
                alert('Please enter data in the textarea.');
                return;
            }

            let originalData;
            try {
                originalData = JSON.parse(inputText);
                if (!Array.isArray(originalData)) {
                    alert('Invalid input: Please enter a valid JSON array.');
                    return;
                }
            } catch (error) {
                alert('Invalid JSON format.');
                return;
            }

            try {
                const response = await fetch('/api/process_direct', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: originalData })
                });
                const processedData = await response.json();

                // Plot the data
                const layout = {
                    title: 'Original Data',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: 'var(--pico-contrast)' }
                };
                Plotly.newPlot(plotOriginalDiv, [{ y: originalData, mode: 'lines+markers', name: 'Original' }], layout);
                Plotly.newPlot(plotProcessedDiv, [{ y: processedData, mode: 'lines+markers', name: 'Processed' }], { ...layout, title: 'Processed Data' });
            } catch (error) {
                console.error('Error processing direct input:', error);
            }
        });
    </script>
</body>
</html>
