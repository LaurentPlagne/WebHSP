<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <title>Hydro Valley Visualizer & Computer</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        /* Ensure body and html take full height */
        html, body {
            height: 100%;
            margin: 0;
        }
        /* Make body a flex container to push main content down */
        body {
            display: flex;
            flex-direction: column;
        }
        /* Make the main content area grow to fill available space */
        main.container {
            flex-grow: 1;
            display: flex; /* Use flexbox for the main container as well */
            flex-direction: column;
        }
        main.container > .grid {
            flex-grow: 1; /* Make the grid fill the main container */
            grid-template-columns: 1fr 1.5fr;
            gap: var(--pico-spacing);
        }
        /* Make the articles within the grid columns stretch */
        .grid > div, .grid > div > article {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        /* Make the graph container fill its parent article */
        #network-graph {
            flex-grow: 1; /* Grow to fill the article */
            border: 1px solid var(--pico-muted-border-color);
        }
        /* Give the results plot a larger, fixed size */
        #results-plot {
            min-height: 450px;
        }
        /* Make the JSON textarea taller */
        #json-input {
            flex-grow: 1;
        }
    </style>
</head>
<body>
    <header class="container">
        <hgroup>
            <h1>Hydro Valley Visualizer & Computer</h1>
            <h2>Define a hydro valley and run computations</h2>
        </hgroup>
        <nav>
            <ul>
                <li><button class="secondary" id="theme-switcher">Toggle Theme</button></li>
            </ul>
        </nav>
    </header>
    <main class="container">
        <div class="grid">
            <!-- Left Column: Inputs & Results -->
            <div>
                <article>
                    <hgroup>
                        <h2>Valley Definition (JSON)</h2>
                        <p>Edit the JSON below to see the graph update in real-time.</p>
                    </hgroup>
                    <textarea id="json-input" rows="25"></textarea>
                    <footer>
                        <button id="compute-btn">Run Simulation</button>
                    </footer>
                </article>
                <article>
                    <hgroup>
                        <h2>Computation Status</h2>
                    </hgroup>
                    <pre><code id="result-output">...</code></pre>
                </article>
            </div>

            <!-- Right Column: Graph -->
            <div>
                <article>
                    <hgroup>
                        <h2>Valley Network Graph</h2>
                    </hgroup>
                    <div id="network-graph"></div>
                </article>
            </div>
        </div>
    </main>
    <script>
        // --- Element References ---
        const jsonInput = document.getElementById('json-input');
        const computeBtn = document.getElementById('compute-btn');
        const resultOutput = document.getElementById('result-output');
        const networkContainer = document.getElementById('network-graph');
        const themeSwitcher = document.getElementById('theme-switcher');
        const htmlElement = document.documentElement;

        // --- Vis.js Network Setup ---
        let network = null;
        const options = {
            physics: {
                solver: 'barnesHut',
                barnesHut: {
                    gravitationalConstant: -8000,
                    springConstant: 0.04,
                    springLength: 150
                }
            },
            edges: {
                arrows: 'to'
            }
        };

        function drawNetwork(valleyData) {
            try {
                const nodes = new vis.DataSet();
                const edges = new vis.DataSet();

                // Add reservoir nodes (V-shape)
                valleyData.reservoirs.forEach(r => {
                    nodes.add({
                        id: r.name,
                        label: r.name,
                        shape: 'triangleDown',
                        color: '#1E90FF' // DodgerBlue
                    });
                });

                // Add unit nodes (circles) and connect them with edges
                valleyData.units.forEach(u => {
                    nodes.add({
                        id: u.name,
                        label: u.name,
                        shape: 'dot',
                        size: 20,
                        color: u.type === 'turbine' ? '#4CAF50' : '#F44336' // Green for turbine, red for pump
                    });
                    // Edge from upstream reservoir to unit
                    edges.add({ from: u.upstream_reservoir, to: u.name });
                    // Edge from unit to downstream reservoir
                    edges.add({ from: u.name, to: u.downstream_reservoir });
                });

                const data = { nodes: nodes, edges: edges };
                if (network === null) {
                    network = new vis.Network(networkContainer, data, options);
                } else {
                    network.setData(data);
                }
            } catch (e) {
                console.error("Failed to draw network:", e);
                if (network) network.setData({ nodes: [], edges: [] }); // Clear graph on error
            }
        }

        // --- Event Listeners ---
        jsonInput.addEventListener('input', () => {
            try {
                const valleyData = JSON.parse(jsonInput.value);
                drawNetwork(valleyData);
            } catch (e) {
                // Gracefully handle incomplete/invalid JSON while typing
                if (network) network.setData({ nodes: [], edges: [] });
            }
        });

        computeBtn.addEventListener('click', async () => {
            resultOutput.textContent = 'Running simulation...';
            try {
                const valleyData = JSON.parse(jsonInput.value);

                const response = await fetch('/api/run_simulation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(valleyData)
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }

                const result = await response.json();

                // Save results to session storage and redirect
                sessionStorage.setItem('simulationResults', JSON.stringify(result));
                window.location.href = 'results.html';

            } catch (e) {
                resultOutput.textContent = `Error: ${e.message}`;
            }
        });

        // --- Theme Switcher ---
        function setTheme(theme) {
            htmlElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }
        themeSwitcher.addEventListener('click', () => {
            const newTheme = htmlElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        });

        // --- Initial Load ---
        async function loadInitialData() {
            try {
                const response = await fetch('/datasets/hydro_valley_instance.json');
                const initialData = await response.json();
                jsonInput.value = JSON.stringify(initialData, null, 2);
                drawNetwork(initialData);
            } catch (e) {
                jsonInput.value = `Error loading initial data: ${e.message}`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            loadInitialData();
        });
    </script>
</body>
</html>
